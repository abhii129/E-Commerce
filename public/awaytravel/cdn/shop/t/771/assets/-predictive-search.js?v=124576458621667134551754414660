var u=Object.defineProperty;var d=(a,h,e)=>h in a?u(a,h,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[h]=e;var n=(a,h,e)=>(d(a,typeof h!="symbol"?h+"":h,e),e);import{B as p}from"./chunk-BaseElement-CopzcQ-j.js";import{d as m,O as g}from"./chunk-debounce-D6ZMjh7U.js";import{L as f}from"./chunk-LiveRegionUtility-tvV1eypT.js";import"./chunk-lit-element-B04JoW0t.js";import"./chunk-aria-live-region-context-DAmBJh4s.js";import"./chunk-create-context-89xeped_.js";class v extends p{constructor(){super(...arguments);n(this,"$liveRegionUtility",new f(this));n(this,"resultsMaxHeight");n(this,"searchTerm","");n(this,"debounceTimeout","");n(this,"input");n(this,"predictiveSearchResults");n(this,"cachedResults",{});n(this,"abortController",new AbortController);n(this,"allPredictiveSearchInstances",[])}connectedCallback(){super.connectedCallback(),this.input=this.querySelector('input[type="search"]'),this.predictiveSearchResults=this.querySelector("[data-predictive-search]"),this.defaultSearchResults=this.querySelector("[data-default-search]"),this.allPredictiveSearchInstances=document.querySelectorAll("predictive-search"),this.setupEventListeners()}setupEventListeners(){this.input.form.addEventListener("submit",this.onFormSubmit.bind(this)),this.input.addEventListener("focus",this.onFocus.bind(this)),this.onChange=m(this.onChange.bind(this),g),this.input.addEventListener("input",this.onChange),this.addEventListener("focusout",this.onFocusOut.bind(this)),this.addEventListener("keyup",this.onKeyup.bind(this)),this.addEventListener("keydown",this.onKeydown.bind(this))}get query(){return this.input.value.trim()}onChange(){var i;const e=this.query;if(!(e&&e.length<3)){if((!this.searchTerm||!e.startsWith(this.searchTerm))&&((i=this.querySelector("#predictive-search-results-groups-wrapper"))==null||i.remove()),this.updateSearchForTerm(this.searchTerm,e),this.searchTerm=e,!this.searchTerm.length){this.close(!0);return}this.getSearchResults(this.searchTerm)}}onFormSubmit(e){(!this.query.length||this.querySelector('[aria-selected="true"] a'))&&e.preventDefault()}onFocus(){const e=this.query;e.length&&(this.searchTerm!==e?this.onChange():this.getAttribute("results")==="true"?this.open():this.getSearchResults(this.searchTerm))}onFocusOut(){setTimeout(()=>{this.contains(document.activeElement)||this.close()})}onKeyup(e){switch(this.query.length||this.close(!0),e.preventDefault(),e.code){case"ArrowUp":this.switchOption("up");break;case"ArrowDown":this.switchOption("down");break;case"Enter":this.selectOption();break}}onKeydown(e){(e.code==="ArrowUp"||e.code==="ArrowDown")&&e.preventDefault()}updateSearchForTerm(e,i){var t;const r=(t=this.searchForTextElement)==null?void 0:t.innerText;if(r){if(r.match(new RegExp(e,"g")).length>1)return;const s=r.replace(e,i);this.searchForTextElement.innerText=s}}switchOption(e){if(!this.getAttribute("open"))return;const i=e==="up";this.selectedElement=this.querySelector('[aria-selected="true"]');const r=Array.from(this.querySelectorAll("li, [data-predictive-search-item]")).filter(o=>o.offsetParent!==null);let t=0;if(i&&!this.selectedElement)return;let s=-1,c=0;for(;s===-1&&c<=r.length;)r[c]===this.selectedElement&&(s=c),c++;if(!i&&this.selectedElement?t=s===r.length-1?0:s+1:i&&(t=s===0?r.length-1:s-1),t===s)return;const l=r[t];l.setAttribute("aria-selected",!0),this.selectedElement&&this.selectedElement.setAttribute("aria-selected",!1),this.input.setAttribute("aria-activedescendant",l.id)}selectOption(){const e=this.querySelector('[aria-selected="true"] a, button[aria-selected="true"]');e&&e.click()}getSearchResults(e){var r;const i=e.replace(" ","-").toLowerCase();if(this.setLiveRegionLoadingState(),(r=this.defaultSearchResults)==null||r.classList.add("hidden"),this.cachedResults[i]){this.renderSearchResults(this.cachedResults[i]);return}fetch(`${window.routes.predictive_search_url}?q=${encodeURIComponent(e)}&section_id=predictive-search`,{signal:this.abortController.signal}).then(t=>{if(!t.ok){var s=new Error(t.status);throw this.close(),s}return t.text()}).then(t=>{const s=new DOMParser().parseFromString(t,"text/html").querySelector("#shopify-section-predictive-search").innerHTML;this.allPredictiveSearchInstances.forEach(c=>{c.cachedResults[i]=s}),this.renderSearchResults(s)}).catch(t=>{if((t==null?void 0:t.code)!==20)throw this.close(),t})}setLiveRegionLoadingState(){this.loadingText=this.loadingText||this.getAttribute("data-loading-text"),this.$liveRegionUtility.announce({message:this.loadingText}),this.setAttribute("loading",!0)}renderSearchResults(e){this.predictiveSearchResults.innerHTML=e,this.setAttribute("results",!0),this.setLiveRegionResults(),this.open()}setLiveRegionResults(){this.removeAttribute("loading"),this.$liveRegionUtility.announce({message:this.querySelector("[data-predictive-search-live-region-count-value]").textContent})}getResultsMaxHeight(){return this.resultsMaxHeight=window.innerHeight-document.querySelector("#header-search").getBoundingClientRect().bottom,this.resultsMaxHeight}open(){this.predictiveSearchResults.style.maxHeight=this.resultsMaxHeight||`${this.getResultsMaxHeight()}px`,this.setAttribute("open",!0),this.input.setAttribute("aria-expanded",!0)}close(e=!1){this.closeResults(e)}closeResults(e=!1){e&&(this.input.value="",this.removeAttribute("results"));const i=this.querySelector('[aria-selected="true"]');i&&i.setAttribute("aria-selected",!1),this.input.setAttribute("aria-activedescendant",""),this.removeAttribute("loading"),this.removeAttribute("open"),this.input.setAttribute("aria-expanded",!1),this.resultsMaxHeight=!1,this.predictiveSearchResults.removeAttribute("style")}}window.customElements.define("predictive-search",v);
