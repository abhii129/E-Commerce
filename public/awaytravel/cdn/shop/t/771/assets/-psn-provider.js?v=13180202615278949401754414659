import{c as v}from"./-psn-context.js";import{P as c,a as h,l as P}from"./-psn-types.js";import{B as L}from"./chunk-BaseElement-CopzcQ-j.js";import{H as x}from"./chunk-HTMLUpdateUtility-Hp59CDcg.js";import{e as b}from"./chunk-provide-C28dEjUe.js";import{t as H}from"./chunk-custom-element-BhZVzxrc.js";import"./chunk-lit-element-B04JoW0t.js";import{r as I}from"./chunk-state-BZNsAlxZ.js";import{e as U}from"./chunk-query-Cgxy6PDT.js";import"./chunk-create-context-89xeped_.js";import"./chunk-WithApiClient-mq4vOvoR.js";import"./chunk-index-CKJCYK2x.js";import"./chunk-firstFocusableElement-BqnhZP5g.js";import"./chunk-context-request-event-GdmzvDV-.js";import"./chunk-property-Bc0RexEQ.js";import"./chunk-base-CShCMygk.js";const F=t=>t==="-"?26:t===" "?-1:t.toLowerCase().charCodeAt(0)-97;var _=Object.defineProperty,E=Object.getOwnPropertyDescriptor,w=(t,e,s,a)=>{for(var n=a>1?void 0:a?E(e,s):e,o=t.length-1,l;o>=0;o--)(l=t[o])&&(n=(a?l(e,s,n):l(n))||n);return a&&n&&_(e,s,n),n};let y=class extends L{constructor(){super(),this.$htmlUpdateUtility=new x(this),this.psn=this.createInitialPSNContext(),this.svgLetters=this.dataset.svgLetters?JSON.parse(this.dataset.svgLetters):[],this.imageFonts=[],this.parentImageFonts=[],this.childImageFonts=[],this.svgLettersCache=[],this.isMobile=window.matchMedia("(max-width: 1023px)").matches,this.boundHandleStepChange=this.handleStepChange.bind(this),this.boundHandleUpsellItemSelection=this.handleUpsellItemSelection.bind(this),this.boundHandleTextInput=this.handleTextInput.bind(this),this.boundHandlePlacementSelected=this.handlePlacementSelected.bind(this),this.boundHandleColorChange=this.handleColorChange.bind(this),this.boundHandleFontStyleChange=this.handleFontStyleChange.bind(this),this.boundHandleMainProductChangeComplete=this.handleMainProductChangeComplete.bind(this),this.boundResetPlacementCoords=this.resetPlacementCoords.bind(this),this.boundModalDialogOpenHandler=this.handleModalDialogOpen.bind(this),this.boundHandlePSNReset=this.resetContext.bind(this)}createInitialPSNContext(){return{mainProduct:{id:this.dataset.initialVariantId??"",prData:this.dataset.prData?JSON.parse(this.dataset.prData):void 0,markdownSale:this.dataset.markdownSale==="true"?!0:void 0,price:this.dataset.productPrice??"",url:this.dataset.productUrl??""},placement:JSON.parse(this.dataset.placementOne||"[]"),hasPlacementStep:this.dataset.hasPlacementStep==="true",hasFontStep:this.dataset.hasFontStep==="true",hasItemPickerStep:this.dataset.hasItemPickerStep==="true",hasFontColorStep:this.dataset.hasFontColorStep==="true",hasImageFont:this.dataset.hasImageFont==="true",fontStyle:this.dataset.defaultFontStyle||"block",isMainProductFinalSale:this.dataset.isMainProductFinalSale==="true",isUpsellProductFinalSale:this.dataset.isUpsellProductFinalSale==="true",letters:"",fontColor:"",fontColorHex:"",step:this.dataset.hasItemPickerStep==="true"?c.ItemPicker:this.dataset.hasPlacementStep==="true"?c.Placement:c.Letters,steps:[],fee:Number(this.dataset.fee)??0,feeId:this.dataset.feeId??"",psnTypeId:this.dataset.psnTypeId??"",additionalCartSwatch:this.dataset.additionalCartSwatch??void 0,showAdditionalProductOnly:this.dataset.showAdditionalProductOnly==="true",pricingCopy:this.dataset.pricingCopy??"",shippingCopy:this.dataset.shippingCopy??window.strings.psn.item_step_legal,fromUrl:!1}}connectedCallback(){var t;super.connectedCallback(),this.fetchAndRenderSVGs=this.fetchAndRenderSVGs.bind(this),this.addEventListener(h.StepChange,this.boundHandleStepChange),this.addEventListener(h.UpsellSelected,this.boundHandleUpsellItemSelection),this.addEventListener(h.TextInput,this.boundHandleTextInput),this.addEventListener(h.PlacementSelected,this.boundHandlePlacementSelected),this.addEventListener(h.FontColorChange,this.boundHandleColorChange),this.addEventListener(h.FontStyleSelected,this.boundHandleFontStyleChange),this.addEventListener("main-product-change-complete",this.boundHandleMainProductChangeComplete),this.addEventListener("resize",this.boundResetPlacementCoords),document.addEventListener("modal-dialog::open",this.boundModalDialogOpenHandler),document.addEventListener("psn::reset",this.boundHandlePSNReset),this.psn.steps=this.calculateTotalSteps(),this.psn.hasImageFont?(this.imageFonts=this.getImageFonts(),this.parentImageFonts=this.imageFonts,this.psn.fontStyle=(t=this.imageFonts[0])==null?void 0:t.font_style.toLowerCase(),this.updateFontImages()):(this.preloadSVG().then(()=>{this.fetchAndRenderSVGs()}),this.psn.shadowColor=this.getDefaultShadowColor(),this.psn.shadowColorHex=this.getDefaultShadowHex()),this.psn.fontColor=this.getDefaultFontColor()||"black",this.psn.fontColorHex=this.getDefaultFontHex()||"#000000",this.getURLParams()}disconnectedCallback(){super.disconnectedCallback(),this.removeEventListener(h.StepChange,this.boundHandleStepChange),this.removeEventListener(h.UpsellSelected,this.boundHandleUpsellItemSelection),this.removeEventListener(h.TextInput,this.boundHandleTextInput),this.removeEventListener(h.PlacementSelected,this.boundHandlePlacementSelected),this.removeEventListener(h.FontColorChange,this.boundHandleColorChange),this.removeEventListener(h.FontStyleSelected,this.boundHandleFontStyleChange),this.removeEventListener("main-product-change-complete",this.boundHandleMainProductChangeComplete),this.removeEventListener("resize",this.boundResetPlacementCoords),document.removeEventListener("modal-dialog::open",this.boundModalDialogOpenHandler),document.removeEventListener("psn::reset",this.boundHandlePSNReset)}resetContext(){var t,e;this.psn=this.createInitialPSNContext(),this.psn.steps=this.calculateTotalSteps(),this.psn.hasImageFont?(this.imageFonts=this.getImageFonts(),this.parentImageFonts=this.imageFonts,this.psn.fontStyle=(t=this.imageFonts[0])==null?void 0:t.font_style.toLowerCase(),this.updateFontImages()):(this.preloadSVG().then(()=>{this.fetchAndRenderSVGs()}),this.psn.shadowColor=this.getDefaultShadowColor(),this.psn.shadowColorHex=this.getDefaultShadowHex()),this.psn.fontColor=this.getDefaultFontColor()||"black",this.psn.fontColorHex=this.getDefaultFontHex()||"#000000",this.updatePlacementCoords(this.psn.placement),this.updatePlacementImages(((e=this.querySelector(`[data-placement-handle='${this.psn.placement[1]}']`))==null?void 0:e.getAttribute("data-placement-image"))??""),this.querySelectorAll("[data-placement-handle]").forEach(s=>{s.dataset.placementHandle===this.psn.placement[1]?s.setAttribute("is-active","true"):s.removeAttribute("is-active")}),this.updateUrl()}handleMainProductChangeComplete(t){var s,a;t.detail.isAdditional?this.updateState({additionalProduct:{id:t.detail.variantId??"",url:t.detail.productUrl??"",price:((s=t.detail.price)==null?void 0:s.toString())??""}}):this.updateState({mainProduct:{id:t.detail.variantId??"",url:t.detail.productUrl??"",price:((a=t.detail.price)==null?void 0:a.toString())??""}});let e=["psn-placement","psn-font-color-picker","psn-font-style-picker"];t.detail.isAdditional||(e=[...e,"psn-item-picker"]),this.$htmlUpdateUtility.fetchAndReplaceSections({renderRoot:this,sectionIds:e,baseUrl:t.detail.productUrl,params:{view:"psn"},withCache:!0,delay:100}).then(()=>{var n;this.psn.fromUrl=!1,this.psn.hasImageFont?this.updateFontImages():this.fetchAndRenderSVGs(),JSON.parse(this.dataset.placementOne)!=this.psn.placement&&!this.psn.additionalProduct&&(this.updatePlacementCoords(this.psn.placement),this.updatePlacementImages(((n=this.querySelector(`[data-placement-handle='${this.psn.placement[1]}']`))==null?void 0:n.getAttribute("data-placement-image"))??""))}).catch(n=>{console.warn(n)}).finally(()=>{this.classList.remove("loading")})}handleModalDialogOpen(t){var a;const e=t;((a=this.closest("dialog"))==null?void 0:a.getAttribute("parent-id"))==e.detail&&this.getURLParams(e.detail)}async safeFetchSVG(t){try{const e=await fetch(t);if(!e.ok)throw new Error(`Failed to fetch ${t}`);return await e.text()}catch(e){return console.error("Error fetching SVG:",e),!1}}async preloadSVG(){this.svgLettersCache=(await Promise.all(this.svgLetters.map(async t=>{if(!t.letter)return;const e=await this.safeFetchSVG(t.letter);return e?{font_style:t.font_style,letter:e,letter_color:t.letter_color,letter_color_hex:t.letter_color_hex,spacing:t.spacing,shadow_color:t.shadow_color,shadow_color_hex:t.shadow_color_hex}:void 0}))).filter(t=>t!==void 0)}getURLParams(t){var f,g,S;let e=new URLSearchParams(window.location.search);t&&(e=window.location.href.indexOf("cart")>-1?(()=>{let p="";return document.querySelectorAll('[id^="psn-"]').forEach(d=>{t===d.id&&(p=d.getAttribute("url")||"")}),new URLSearchParams(p)})():new URLSearchParams(window.location.search));const s=e.get("placement"),a=e.get("letters"),n=e.get("font-color"),o=e.get("font-color-hex"),l=e.get("shadow-color"),i=e.get("shadow-color-hex"),r=e.get("line-item-key"),m=e.get("additional-product"),u=e.get("font-style");if(m){n&&(this.updateState({fontColor:n}),this.updateState({fontColorHex:`#${o}`})),u&&this.updateState({fontStyle:u}),r&&this.updateState({lineItemKey:r}),a&&this.updateState({letters:a}),this.updateState({fromUrl:!0}),(f=this.closest("psn-provider"))==null||f.classList.add("loading"),this.psn.showAdditionalProductOnly?this.$emit("main-product-change-complete",{variantId:m,productUrl:this.dataset.additionalProductUrl,isAdditional:!0}):setTimeout(()=>{this.querySelector("[is-upsell]").click()},0);return}if(n&&(this.updateState({fontColor:n}),this.updateState({fontColorHex:`#${o}`})),u&&this.updateState({fontStyle:u}),l&&(this.updateState({shadowColor:l}),!this.psn.hasImageFont&&i&&this.updateState({shadowColorHex:`#${i}`})),a&&(this.updateState({letters:a}),this.psn.hasImageFont?this.updateFontImages():this.fetchAndRenderSVGs()),s&&this.psn.hasPlacementStep){const p=JSON.parse(((g=this.querySelector(`[data-placement-handle='${s}']`))==null?void 0:g.getAttribute("data-placement-info"))??"");this.updateState({placement:p}),this.updatePlacementCoords(p),this.updatePlacementImages(((S=this.querySelector(`[data-placement-handle='${s}']`))==null?void 0:S.getAttribute("data-placement-image"))??""),this.querySelectorAll("[data-placement-handle]").forEach(d=>{d.dataset.placementHandle===s?d.setAttribute("is-active","true"):d.removeAttribute("is-active")})}r&&this.updateState({lineItemKey:r})}getImageFonts(){const t=this.querySelector("#psn-image-fonts");if(t)return JSON.parse(t.innerHTML)}getDefaultFontColor(){return this.psn.hasImageFont?this.imageFonts[0].letter_color:this.dataset.defaultFontColor}getDefaultFontHex(){return this.psn.hasImageFont?this.imageFonts[0].letter_color_hex:this.dataset.defaultFontColorHex}getDefaultShadowColor(){return this.dataset.defaultShadowColor||""}getDefaultShadowHex(){return this.dataset.defaultShadowColorHex||""}resetPlacementCoords(){this.isMobile=window.matchMedia("(max-width: 1023px)").matches,this.updatePlacementCoords(this.psn.placement)}calculateTotalSteps(){return[this.psn.hasItemPickerStep&&c.ItemPicker,this.psn.hasPlacementStep&&c.Placement,c.Letters,this.psn.hasFontStep&&c.FontStyle,this.psn.hasFontColorStep&&c.FontColor].filter(e=>e!==!1)}updateState(t){this.psn={...this.psn,...t}}async fetchAndRenderSVGs(){if(this.svgLettersCache.length===0)return;const t=this.svgLettersCache.filter(o=>o.font_style.toLowerCase()===this.psn.fontStyle.toLowerCase()),e=this.letterContainer,s=this.psn.placement[9]||"AWY",n=(this.psn.letters.length?this.psn.letters:s).split("").map(o=>F(o)).map(o=>o===-1?"space":t[o]);this.letterContainer.innerHTML="";for(const o of n){const l=document.createElement("div");o==="space"?(l.innerHTML=" ",l.classList.add("w-4")):o&&o.letter&&(l.innerHTML=o.letter),e.appendChild(l)}this.updateSVG(this.psn.fontColorHex,"font"),this.psn.shadowColorHex&&this.updateSVG(this.psn.shadowColorHex,"shadow")}updateUrl(){const t=new URLSearchParams(window.location.search);t.has("modals")&&(t.set("modals","psn"),t.set("step",this.psn.step),this.psn.mainProduct&&t.set("parent-product",this.psn.mainProduct.id),this.psn.additionalProduct&&this.psn.additionalProduct.id!=this.psn.mainProduct.id?(t.set("additional-product",this.psn.additionalProduct.id),t.delete("shadow-color")):(t.delete("additional-product"),t.set("shadow-color",this.psn.shadowColor??this.getDefaultShadowColor())),this.psn.letters&&this.psn.letters.length>0&&t.set("letters",this.psn.letters),this.psn.placement&&t.set("placement",this.psn.placement[1]),this.psn.fontColor&&t.set("font-color",this.psn.fontColor),this.psn.fontColorHex&&t.set("font-color-hex",this.psn.fontColorHex.replace("#","")),!this.psn.additionalProduct&&this.psn.shadowColor&&t.set("shadow-color",this.psn.shadowColor),!this.psn.additionalProduct&&this.psn.shadowColorHex&&t.set("shadow-color-hex",this.psn.shadowColorHex.replace("#","")),this.psn.fontStyle&&t.set("font-style",this.psn.fontStyle),window.history.replaceState({},"",window.location.pathname+"?"+t.toString()))}handleStepChange(t){const e=t;this.updateState({step:e.detail}),this.updateUrl()}handleUpsellItemSelection(t){var o,l,i,r,m,u,f,g,S,p;const e=t.detail.product&&t.detail.product.id===this.psn.mainProduct.id;this.updateState({additionalProduct:e?void 0:t.detail.product,fee:t.detail.fee,feeId:t.detail.feeId,psnTypeId:t.detail.psnTypeId});const s=e?this.dataset:t.detail.button.dataset,a=JSON.parse(s.placementOne),n=new RegExp(P(parseInt(a[8])));if(parseInt(a[8])<parseInt(this.psn.placement[8])){const d=this.psn.letters.slice(0,parseInt(a[8]));this.updateState({letters:d})}else n.test(this.psn.letters)||this.updateState({letters:""});if(t.detail.button){const d={placement:a,hasPlacementStep:s.hasPlacementStep==="true",hasFontStep:s.hasFontStep==="true",hasImageFont:s.hasImageFont==="true",additionalCartSwatch:s.additionalCartSwatch??void 0,pricingCopy:s.pricingCopy??"",shippingCopy:s.shippingCopy??window.strings.psn.item_step_legal};if(this.updateState(d),this.psn.steps=this.calculateTotalSteps(),this.psn.hasImageFont&&t.detail.imageFonts)this.imageFonts=e?this.parentImageFonts:t.detail.imageFonts,this.childImageFonts=e?[]:t.detail.imageFonts,t.detail.fromUrl||(this.psn.fontStyle=(o=this.imageFonts[0])==null?void 0:o.font_style.toLowerCase());else{const C=(l=this.svgLettersCache[0])==null?void 0:l.font_style;this.updateState({fontStyle:C})}this.psn.hasFontStep&&this.querySelectorAll("[is-font-style-button]").forEach(C=>{C.value===this.psn.fontStyle.toLowerCase()?C.setAttribute("is-active","true"):C.removeAttribute("is-active")}),t.detail.fromUrl||(this.psn.fontColor=this.getDefaultFontColor()||"black",this.psn.fontColorHex=this.getDefaultFontHex()||"#000000"),this.updatePlacementCoords(this.psn.placement),s.hasFontStep==="true"?(r=(i=this.closest("psn-provider"))==null?void 0:i.querySelector("#font-style-picker"))==null||r.classList.remove("hidden"):(u=(m=this.closest("psn-provider"))==null?void 0:m.querySelector("#font-style-picker"))==null||u.classList.add("hidden"),e?(g=(f=this.querySelector("#shopify-section-psn-product"))==null?void 0:f.querySelector("psn-item-color-picker"))==null||g.classList.remove("!hidden"):(p=(S=this.querySelector("#shopify-section-psn-product"))==null?void 0:S.querySelector("psn-item-color-picker"))==null||p.classList.add("!hidden")}this.updateUrl()}handleTextInput(t){const e=t,s=parseInt(this.psn.placement[8])||3;(new RegExp(P(s)).test(e.detail)||e.detail.length===0)&&(this.updateState({letters:e.detail}),this.updateUrl(),this.psn.hasImageFont?this.updateFontImages():this.fetchAndRenderSVGs())}updatePlacementCoords(t){const e=t[this.isMobile?4:5]+"%",s=t[this.isMobile?2:3]+"%",a=t[this.isMobile?6:7]+"%";this.style.setProperty("--letter-pos-y",e),this.style.setProperty("--letter-pos-x",s),this.style.setProperty("--letter-scale",a)}updatePlacementImages(t){if(t.length===0)return;const e=this.querySelector("#psn-gallery-image");e&&(e.src=t,e.removeAttribute("srcset"))}handlePlacementSelected(t){const e=t,s=e.detail.value,a=new RegExp(P(parseInt(s[8])));if(parseInt(s[8])<parseInt(this.psn.placement[8])){if(this.updateState({placement:e.detail.value}),this.psn.letters.length){const n=a.test(this.psn.letters)?this.psn.letters.slice(0,parseInt(s[8])):"";this.updateState({letters:n})}else this.updateState({letters:""});this.psn.hasImageFont?this.updateFontImages():this.fetchAndRenderSVGs()}else parseInt(s[8])>parseInt(this.psn.placement[8])&&!this.psn.letters.length?(this.updateState({placement:e.detail.value}),this.psn.hasImageFont?this.updateFontImages():this.fetchAndRenderSVGs()):this.updateState({placement:e.detail.value});this.updatePlacementImages(e.detail.image),this.updatePlacementCoords(e.detail.value),this.updateUrl()}handleColorChange(t){const e=t,s=e.detail.label.replace(" ","-").toLowerCase();e.detail.type==="font"?this.updateState({fontColor:s,fontColorHex:e.detail.value}):this.updateState({shadowColor:s,shadowColorHex:e.detail.value}),this.updateUrl(),this.psn.hasImageFont?this.updateFontImages():this.updateSVG(e.detail.value,e.detail.type)}async updateSVG(t,e){this.letterContainer.querySelectorAll("svg").forEach(s=>{var a;(a=s.querySelector(e=="font"?"g":"g:nth-of-type(2)"))==null||a.setAttribute("fill",t)})}handleFontStyleChange(t){var n;const e=(n=t.detail)==null?void 0:n.toLowerCase(),s=this.imageFonts.find(o=>o.font_style.toLowerCase()===e&&o.letter_color===this.psn.fontColor)||this.imageFonts.find(o=>o.font_style.toLowerCase()===e),a=this.svgLettersCache.find(o=>o.font_style.toLowerCase()===e.toLowerCase());if(!(this.psn.hasImageFont&&!s))if(this.psn.hasImageFont&&s){this.updateState({fontColor:s.letter_color,fontColorHex:s.letter_color_hex,fontStyle:e}),this.style.setProperty("--spacing",`${s.spacing||0}%`),this.updateUrl(),this.updateFontImages();return}else{if(!this.psn.hasImageFont&&!a)return;if(!this.psn.hasImageFont&&a){this.updateState({fontColor:a.letter_color,fontColorHex:a.letter_color_hex,fontStyle:e,shadowColor:a.shadow_color,shadowColorHex:a.shadow_color_hex}),this.style.setProperty("--spacing",`${a.spacing||0}%`),this.updateUrl(),this.fetchAndRenderSVGs();return}}}updateFontImages(){var l;const t=((l=this.psn.fontStyle)==null?void 0:l.toLowerCase())||this.imageFonts[0].font_style.toLowerCase(),e=this.psn.fontColor||this.imageFonts[0].letter_color,s=this.psn.letters.length?this.imageFonts.find(i=>i.font_style.toLowerCase()===t&&i.letter_color===e):this.imageFonts[0];if(!s)return;const a=this.psn.placement[9],n=this.letterContainer,o=this.psn.letters?this.psn.letters.split("").map(i=>F(i)).map(i=>i===-1?"space":i):a.split("").map(i=>F(i)).map(i=>i===-1?"space":i);n.innerHTML="";for(const i of o)if(i==="space"){const r=document.createElement("div");r.innerHTML=" ",r.classList.add("w-4"),n.appendChild(r)}else if(s.letter_image_files[i]){const r=document.createElement("img");r.src=s.letter_image_files[i],r.style.width="auto",n.appendChild(r)}else return}};w([b({context:v}),I()],y.prototype,"psn",2);w([I()],y.prototype,"svgLettersCache",2);w([U("#letter-container")],y.prototype,"letterContainer",2);y=w([H("psn-provider")],y);
